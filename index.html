<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>6-Day Workout Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 1rem; }
    select, button { margin: 0.5rem 0; padding: 0.5rem; font-size: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ddd; padding: 0.5rem; text-align: center; }
    td[contenteditable] { background: #f9f9f9; }
    #tableContainer { overflow-x: auto; }
  </style>
</head>
<body>
  <h1>6-Day Workout Tracker</h1>

  <label for="sheetSelect">Choose Day:</label>
  <select id="sheetSelect" disabled></select>
  <button id="addWeekBtn" disabled>Add New Week</button>
  <button id="delWeekBtn" disabled>Delete Last Week</button>
  <button id="exportBtn" disabled>Export All Days</button>

  <div id="tableContainer"></div>

  <script>
    let workbook;
    const sheetSelect = document.getElementById('sheetSelect');
    const addWeekBtn  = document.getElementById('addWeekBtn');
    const delWeekBtn  = document.getElementById('delWeekBtn');
    const exportBtn   = document.getElementById('exportBtn');
    const tableContainer = document.getElementById('tableContainer');

    async function loadWorkbook() {
      try {
        const resp = await fetch('workout.xlsx');
        console.log('Fetch workout.xlsx status:', resp.status);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const arrayBuffer = await resp.arrayBuffer();
        workbook = XLSX.read(arrayBuffer, { type: 'array' });
        initializeApp();
      } catch (err) {
        console.error('Failed to load workout.xlsx:', err);
        tableContainer.textContent = 'Error: could not load workout.xlsx from server.';
      }
    }

    function initializeApp() {
      populateSheetSelect();
      addWeekBtn.disabled = false;
      delWeekBtn.disabled = false;
      exportBtn.disabled = false;
    }

    function populateSheetSelect() {
      sheetSelect.innerHTML = '';
      workbook.SheetNames.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        sheetSelect.appendChild(opt);
      });
      sheetSelect.disabled = false;
      sheetSelect.onchange = () => loadAndRender(sheetSelect.value);
      loadAndRender(workbook.SheetNames[0]);
    }

    function loadAndRender(sheetName) {
      const saved = localStorage.getItem(`workout_${sheetName}`);
      const data = saved
        ? JSON.parse(saved)
        : XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1, defval: '' });
      renderTable(sheetName, data);
    }

    function renderTable(sheetName, data) {
      tableContainer.innerHTML = '';
      const table = document.createElement('table');
      const colCount = data[0]?.length || 0;
      data.forEach((row, r) => {
        const tr = document.createElement('tr');
        for (let c = 0; c < colCount; c++) {
          const cellEl = document.createElement(r === 0 ? 'th' : 'td');
          cellEl.textContent = row[c] || '';
          if (r > 0) {
            cellEl.contentEditable = 'true';
            cellEl.spellcheck = false;
            cellEl.onblur = () => saveSheet(sheetName, table);
          }
          tr.appendChild(cellEl);
        }
        table.appendChild(tr);
      });
      tableContainer.appendChild(table);
      sheetSelect.value = sheetName;
    }

    function saveSheet(sheetName, table) {
      const arr = [];
      table.querySelectorAll('tr').forEach(tr => {
        const row = [];
        tr.querySelectorAll('th, td').forEach(cell => row.push(cell.textContent));
        arr.push(row);
      });
      localStorage.setItem(`workout_${sheetName}`, JSON.stringify(arr));
    }

    addWeekBtn.onclick = () => modifyWeeks(1);
    delWeekBtn.onclick = () => modifyWeeks(-1);

    function modifyWeeks(delta) {
      const sheetName = sheetSelect.value;
      const saved = localStorage.getItem(`workout_${sheetName}`);
      const data = saved
        ? JSON.parse(saved)
        : XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header:1, defval: '' });
      const header = data[0];
      const fixedCols = 5; // Exercise, Set #, Target Reps, Rest, (initial) Target Wt
      let weeks = Math.floor((header.length - fixedCols) / 3);
      if (delta > 0) {
        const w = weeks + 1;
        header.push(`Actual Reps Wk${w}`, `Weight Wk${w}`, `Target Wt Wk${w+1}`);
        for (let i = 1; i < data.length; i++) data[i].push('','','');
      } else if (delta < 0 && weeks > 0) {
        header.splice(-3);
        for (let i = 1; i < data.length; i++) data[i].splice(-3);
      }
      localStorage.setItem(`workout_${sheetName}`, JSON.stringify(data));
      renderTable(sheetName, data);
    }

    exportBtn.onclick = () => {
      const newWb = XLSX.utils.book_new();
      workbook.SheetNames.forEach(name => {
        const saved = localStorage.getItem(`workout_${name}`);
        const arr = saved
          ? JSON.parse(saved)
          : XLSX.utils.sheet_to_json(workbook.Sheets[name], { header:1, defval: '' });
        const ws = XLSX.utils.aoa_to_sheet(arr);
        XLSX.utils.book_append_sheet(newWb, ws, name);
      });
      XLSX.writeFile(newWb, 'updated_workout.xlsx');
    };

    // Start here
    loadWorkbook();
  </script>
</body>
</html>
