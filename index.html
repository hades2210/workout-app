<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>6-Day Workout Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 1rem; }
    h1, h2 { margin-bottom: 0.5rem; }
    select, input, button { margin: 0.5rem 0; padding: 0.5rem; font-size: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ddd; padding: 0.5rem; text-align: center; }
    td[contenteditable] { background: #f9f9f9; }
  </style>
</head>
<body>
  <h1>6-Day Workout Tracker</h1>
  <input type="file" id="fileInput" accept=".xlsx,.xls">
  <br>
  <label for="sheetSelect">Choose Day:</label>
  <select id="sheetSelect" disabled></select>
  <button id="addWeekBtn" disabled>Add New Week</button>
  <button id="delWeekBtn" disabled>Delete Last Week</button>
  <button id="exportBtn" disabled>Export All Days</button>
  <div id="tableContainer"></div>

  <script>
    let workbook;
    const fileInput = document.getElementById('fileInput');
    const sheetSelect = document.getElementById('sheetSelect');
    const addWeekBtn = document.getElementById('addWeekBtn');
    const delWeekBtn = document.getElementById('delWeekBtn');
    const exportBtn = document.getElementById('exportBtn');
    const tableContainer = document.getElementById('tableContainer');

    // Load file
    fileInput.addEventListener('change', async e => {
      const file = e.target.files[0];
      if (!file) return;
      const data = await file.arrayBuffer();
      workbook = XLSX.read(data, { type: 'array' });
      populateSheetSelect();
      addWeekBtn.disabled = false;
      delWeekBtn.disabled = false;
      exportBtn.disabled = false;
    });

    // Populate dropdown with sheet names
    function populateSheetSelect() {
      sheetSelect.innerHTML = '';
      workbook.SheetNames.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        sheetSelect.appendChild(opt);
      });
      sheetSelect.disabled = false;
      sheetSelect.onchange = () => loadAndRender(sheetSelect.value);
      loadAndRender(workbook.SheetNames[0]);
    }

    // Load from localStorage or workbook
    function loadAndRender(sheetName) {
      const saved = localStorage.getItem(`workout_${sheetName}`);
      const data = saved ? JSON.parse(saved) : XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1, defval: "" });
      renderTable(sheetName, data);
    }

    // Render table with all cells editable
    function renderTable(sheetName, data) {
      tableContainer.innerHTML = '';
      const table = document.createElement('table');
      const colCount = data[0] ? data[0].length : 0;
      data.forEach((row, r) => {
        const tr = document.createElement('tr');
        for (let c = 0; c < colCount; c++) {
          const cell = row[c] || '';
          const cellEl = document.createElement(r === 0 ? 'th' : 'td');
          cellEl.textContent = cell;
          if (r > 0) {
            cellEl.contentEditable = 'true';
            cellEl.spellcheck = false;
            cellEl.onblur = () => saveSheet(sheetName, table);
          }
          tr.appendChild(cellEl);
        }
        table.appendChild(tr);
      });
      tableContainer.appendChild(table);
      sheetSelect.value = sheetName;
    }

    // Save sheet state to localStorage
    function saveSheet(sheetName, table) {
      const arr = [];
      table.querySelectorAll('tr').forEach(tr => {
        const row = [];
        tr.querySelectorAll('th, td').forEach(cell => row.push(cell.textContent));
        arr.push(row);
      });
      localStorage.setItem(`workout_${sheetName}`, JSON.stringify(arr));
    }

    // Add or delete week columns
    addWeekBtn.addEventListener('click', () => modifyWeeks(1));
    delWeekBtn.addEventListener('click', () => modifyWeeks(-1));

    function modifyWeeks(delta) {
      const sheetName = sheetSelect.value;
      const saved = localStorage.getItem(`workout_${sheetName}`);
      const data = saved ? JSON.parse(saved) : XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1, defval: "" });
      const header = data[0];
      const fixedCols = 4; // Exercise, Set #, Target Reps, Rest
      let weekCount = Math.floor((header.length - fixedCols) / 3);
      if (delta > 0) {
        const nextWeek = weekCount + 1;
        // push actual, weight, target for next week
        header.push(`Actual Reps Wk${nextWeek}`, `Weight Wk${nextWeek}`, `Target Wt Wk${nextWeek}`);
        for (let i = 1; i < data.length; i++) data[i].push('', '', '');
      } else if (delta < 0 && weekCount > 0) {
        // remove last 3 columns
        for (let i = 0; i < 3; i++) header.pop();
        for (let i = 1; i < data.length; i++) data[i].splice(-3);
      }
      localStorage.setItem(`workout_${sheetName}`, JSON.stringify(data));
      renderTable(sheetName, data);
    }

    // Export all sheets to updated_workout.xlsx
    exportBtn.addEventListener('click', () => {
      const newWb = XLSX.utils.book_new();
      workbook.SheetNames.forEach(name => {
        const saved = localStorage.getItem(`workout_${name}`);
        const arr = saved ? JSON.parse(saved) : XLSX.utils.sheet_to_json(workbook.Sheets[name], { header: 1, defval: "" });
        const ws = XLSX.utils.aoa_to_sheet(arr);
        XLSX.utils.book_append_sheet(newWb, ws, name);
      });
      XLSX.writeFile(newWb, 'updated_workout.xlsx');
    });
  </script>
</body>
</html>
